name: Daily Trend Scanner

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  trigger-scanner:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Trigger Writer Blueprint
        id: trigger
        run: |
          echo "üöÄ Triggering Writer Blueprint..."
          
          response=$(curl -s --location --request POST \
            "https://api.writer.com/v1/agents/${{ secrets.WRITER_AGENT_ID }}/blueprints/${{ secrets.WRITER_BLUEPRINT_ID }}/jobs" \
            --header "Authorization: Bearer ${{ secrets.WRITER_API_KEY }}" \
            --header "Content-Type: application/json" \
            --data '{"inputs": []}')
          
          echo "Response: $response"
          
          # Extract job_id
          job_id=$(echo "$response" | grep -o '"job_id":"[^"]*"' | cut -d'"' -f4)
          
          if [ -z "$job_id" ]; then
            echo "‚ùå No job_id returned"
            echo "Full response: $response"
            exit 1
          fi
          
          echo "‚úì Job triggered! ID: $job_id"
          echo "job_id=$job_id" >> $GITHUB_OUTPUT
      
      - name: Wait for completion
        run: |
          job_id="${{ steps.trigger.outputs.job_id }}"
          echo "‚è≥ Monitoring job: $job_id"
          
          max_attempts=60
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            status_response=$(curl -s \
              "https://api.writer.com/v1/agents/jobs/$job_id" \
              --header "Authorization: Bearer ${{ secrets.WRITER_API_KEY }}")
            
            status=$(echo "$status_response" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
            
            echo "[$((attempt+1))/$max_attempts] Status: $status"
            
            if [ "$status" = "completed" ]; then
              echo "‚úì Blueprint completed successfully!"
              exit 0
            elif [ "$status" = "failed" ]; then
              echo "‚ùå Blueprint failed"
              echo "Details: $status_response"
              exit 1
            fi
            
            sleep 10
            attempt=$((attempt+1))
          done
          
          echo "‚è± Timeout after 10 minutes"
          exit 1

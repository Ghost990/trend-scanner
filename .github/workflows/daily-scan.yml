name: Daily Trend Scanner

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  trigger-scanner:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Blueprint
        id: trigger
        run: |
          response=$(curl -s -X POST "https://api.writer.com/v1/agents/${{ secrets.WRITER_AGENT_ID }}/blueprints/${{ secrets.WRITER_BLUEPRINT_ID }}/jobs" \
            --header "Authorization: Bearer ${{ secrets.WRITER_API_KEY }}" \
            --header "Content-Type: application/json" \
            --data '{"inputs": []}')
          
          echo "Response: $response"
          
          job_id=$(echo "$response" | jq -r '.job_id // empty')
          poll_url=$(echo "$response" | jq -r '.poll_url // empty')
          
          if [ -z "$job_id" ]; then
            echo "❌ No job ID returned"
            exit 1
          fi
          
          echo "Job ID: $job_id"
          echo "Poll URL: $poll_url"
          echo "job_id=$job_id" >> $GITHUB_OUTPUT
          echo "poll_url=$poll_url" >> $GITHUB_OUTPUT
      
      - name: Wait for completion
        run: |
          poll_url="${{ steps.trigger.outputs.poll_url }}"
          
          echo "Monitoring job via: $poll_url"
          max_attempts=60
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            status_response=$(curl -s "https://api.writer.com${poll_url}" \
              --header "Authorization: Bearer ${{ secrets.WRITER_API_KEY }}")
            
            status=$(echo "$status_response" | jq -r '.status // empty')
            
            echo "[$((attempt+1))/$max_attempts] Status: $status"
            
            if [ "$status" = "completed" ]; then
              echo "✓ Blueprint completed successfully!"
              echo "$status_response" | jq '.'
              exit 0
            elif [ "$status" = "failed" ]; then
              echo "❌ Blueprint failed"
              echo "$status_response" | jq '.'
              exit 1
            fi
            
            sleep 10
            attempt=$((attempt+1))
          done
          
          echo "⏱ Timeout waiting for completion"
          echo "Last status:"
          curl -s "https://api.writer.com${poll_url}" \
            --header "Authorization: Bearer ${{ secrets.WRITER_API_KEY }}" | jq '.'
          exit 1

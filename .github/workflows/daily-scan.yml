name: Daily Trend Scanner

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  trigger-scanner:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Blueprint (Async)
        id: trigger
        run: |
          response=$(curl -s --location --request POST "https://api.writer.com/v1/agents/${{ secrets.WRITER_AGENT_ID }}/blueprints/${{ secrets.WRITER_BLUEPRINT_ID }}/async-run" \
            --header "Authorization: Bearer ${{ secrets.WRITER_API_KEY }}" \
            --header "Content-Type: application/json" \
            --data '{"inputs": []}')
          
          echo "Response: $response"
          
          job_id=$(echo "$response" | grep -o '"job_id":"[^"]*"' | cut -d'"' -f4)
          echo "Job ID: $job_id"
          echo "job_id=$job_id" >> $GITHUB_OUTPUT
      
      - name: Wait for completion
        run: |
          job_id="${{ steps.trigger.outputs.job_id }}"
          
          if [ -z "$job_id" ]; then
            echo "❌ No job ID returned"
            exit 1
          fi
          
          echo "Monitoring job: $job_id"
          max_attempts=60
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            status_response=$(curl -s --location "https://api.writer.com/v1/agents/jobs/$job_id" \
              --header "Authorization: Bearer ${{ secrets.WRITER_API_KEY }}")
            
            status=$(echo "$status_response" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
            
            echo "[$((attempt+1))/$max_attempts] Status: $status"
            
            if [ "$status" = "completed" ]; then
              echo "✓ Blueprint completed successfully!"
              exit 0
            elif [ "$status" = "failed" ]; then
              echo "❌ Blueprint failed"
              echo "Details: $status_response"
              exit 1
            fi
            
            sleep 10
            attempt=$((attempt+1))
          done
          
          echo "⏱ Timeout after $((max_attempts*10)) seconds"
          exit 1
